{
  "memories": [
    {
      "id": "mem_search_001",
      "content": "Azure OpenAI Embedding クライアントの実装: openai>=1.0.0のAzureOpenAIクラスを使用し、環境変数（AZURE_OPENAI_ENDPOINT/OpenAIEmbeddingURI, AZURE_OPENAI_API_KEY/OpenAIEmbeddingKey）から設定を読み込む。APIバージョン2024-02-01を指定し、text-embedding-3-smallモデルで1536次元のベクトルを生成する。",
      "scope_level": "domain",
      "scope_domain": "embedding",
      "scope_project": "llm-persistent-memory-phase1",
      "strength": 1.0,
      "strength_by_perspective": {
        "検索精度": 1.3,
        "レスポンス性能": 1.2,
        "スケーラビリティ": 1.0,
        "API連携": 1.5,
        "フォールバック": 1.2
      },
      "learnings": {
        "検索精度": "text-embedding-3-smallは1536次元でコストと精度のバランスが良い。空文字列やホワイトスペースのみの入力は検索精度を下げるため事前にバリデーションが必要。",
        "レスポンス性能": "複数テキストのバッチ処理（get_embeddings）を使用することで、APIコール数を削減しレスポンス時間を短縮できる。",
        "スケーラビリティ": "シングルトンパターンでクライアントインスタンスを管理することで、接続の再利用とリソース効率を向上。",
        "API連携": "Azure OpenAI APIはapiversion指定が必須。openai>=1.0.0のAzureOpenAIクラスを使用することで標準OpenAI APIとの互換性を維持しつつAzure形式のエンドポイントを使用可能。環境変数は複数パターン（AZURE_* / OpenAI*）をサポートし運用柔軟性を確保。",
        "フォールバック": "環境変数が設定されていない場合は明確なエラーメッセージで早期失敗。is_available()メソッドで接続テストが可能。"
      },
      "access_count": 0,
      "candidate_count": 0,
      "consolidation_level": 0,
      "status": "active",
      "source": "task_execution",
      "created_at": "2026-01-13T08:29:36Z",
      "updated_at": "2026-01-13T08:29:36Z",
      "last_accessed_at": null
    },
    {
      "id": "mem_search_002",
      "content": "ベクトル検索（Stage 1: 関連性フィルタ）の実装: pgvectorの<=>演算子（cosine距離）を使用してクエリベクトルとメモリベクトルの類似度を計算。類似度=1-距離で変換し、similarity_threshold=0.3以上の候補をcandidate_limit=50件まで取得。status='active'かつembedding IS NOT NULLのレコードのみを検索対象とする。",
      "scope_level": "domain",
      "scope_domain": "vector_search",
      "scope_project": "llm-persistent-memory-phase1",
      "strength": 1.0,
      "strength_by_perspective": {
        "検索精度": 1.4,
        "レスポンス性能": 1.3,
        "スケーラビリティ": 1.2,
        "API連携": 1.3,
        "フォールバック": 1.2
      },
      "learnings": {
        "検索精度": "pgvectorのcosine距離による類似度検索は、similarity_threshold=0.3でノイズを効果的にフィルタリングできる。テストでは「緊急調達のコスト」クエリに対し正解記憶が類似度0.765で1位返却、無関係な記憶は閾値以下で除外された。",
        "レスポンス性能": "candidate_limit=50で候補数を制限することでStage 2ランキングの負荷を軽減。search_by_embeddingメソッドで事前計算済みエンベディングを使用すればAPI呼び出しを節約可能。",
        "スケーラビリティ": "Phase 1では線形スキャン（インデックスなし）で十分。1万件を超えた場合はCREATE INDEX ... USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100)の追加を検討。",
        "API連携": "AzureEmbeddingClientとの統合は依存注入パターンで実現。エンベディング取得エラーはAzureEmbeddingErrorをキャッチしVectorSearchErrorとして再スローすることでエラーの追跡性を確保。",
        "フォールバック": "空文字列や空白のみのクエリは早期にログ警告を出力し空リストを返す安全な処理。embedding IS NOT NULLフィルタでエンベディング未設定レコードを除外し検索エラーを防止。"
      },
      "access_count": 0,
      "candidate_count": 0,
      "consolidation_level": 0,
      "status": "active",
      "source": "task_execution",
      "created_at": "2026-01-13T08:42:00Z",
      "updated_at": "2026-01-13T08:42:00Z",
      "last_accessed_at": null
    },
    {
      "id": "mem_search_003",
      "content": "スコア合成（Stage 2: 優先度ランキング）の実装: Stage 1の候補に対してfinal_score = similarity*0.50 + normalized_strength*0.30 + recency_score*0.20で総合スコアを計算。strengthは0-1に正規化（min(strength, 2.0)/2.0）、recency_scoreは指数減衰（exp(-days_since_access/30)）で計算。TOP_K_RESULTS=10件をスコア降順で返却。観点指定時はstrength_by_perspective[perspective]を使用。",
      "scope_level": "domain",
      "scope_domain": "vector_search",
      "scope_project": "llm-persistent-memory-phase1",
      "strength": 1.0,
      "strength_by_perspective": {
        "検索精度": 1.4,
        "レスポンス性能": 1.3,
        "スケーラビリティ": 1.2,
        "API連携": 1.1,
        "フォールバック": 1.3
      },
      "learnings": {
        "検索精度": "線形スコア合成（類似度0.50+強度0.30+新鮮さ0.20）で多角的評価を実現。類似度を最重視しつつ、強度と新鮮さで補助的にランキングを調整。観点（perspective）指定によりユースケースに応じた強度評価が可能。",
        "レスポンス性能": "Stage 1で候補を50件に絞り込んでいるためStage 2はメモリ内計算のみで完結。DBやAPI呼び出しなしで高速なランキングを実現。score_breakdownでデバッグ時の分析も容易。",
        "スケーラビリティ": "Phase 1は線形スコアで十分な検索品質を確保。MIN_TRAINING_SAMPLES=100件の使用ログが蓄積された後、Phase 2でニューラルスコアラーへの移行を検討可能な設計。",
        "API連携": "MemoryRankerは外部依存なしの純粋なロジッククラス。VectorSearchとの疎結合でテストが容易。Phase1Configからscore_weightsとtop_k_resultsを取得し設定変更に柔軟に対応。",
        "フォールバック": "観点指定時にstrength_by_perspectiveに該当観点がない場合は全体のstrengthにフォールバック。last_accessed_atがNULLの場合はcreated_atを使用してrecencyを計算。負の強度は0.0にクリップし安全性を確保。"
      },
      "access_count": 0,
      "candidate_count": 0,
      "consolidation_level": 0,
      "status": "active",
      "source": "task_execution",
      "created_at": "2026-01-13T09:00:00Z",
      "updated_at": "2026-01-13T09:00:00Z",
      "last_accessed_at": null
    }
  ]
}
